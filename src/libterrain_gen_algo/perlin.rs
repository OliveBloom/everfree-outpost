use std::hash::{Hash, Hasher, SipHasher};
use libserver_types::*;

pub struct Params {
    pub resolution: i32,
    pub offset: V2,
    pub magnitude: i32,
    pub seed: u64,
}

fn smooth(x: f64) -> f64 {
    let x2 = x * x;
    let x3 = x2 * x;
    let x4 = x3 * x;
    let x5 = x4 * x;
    6.0 * x5 - 15.0 * x4 + 10.0 * x3
}

fn hash_point(seed: u64, p: V2) -> u64 {
    let mut sip = SipHasher::new_with_keys(seed, 0x1234567);
    p.hash(&mut sip);
    sip.finish()
}

pub fn sample(p: &Params, pos: V2) -> i32 {
    let pos = pos - p.offset;
    let cell = pos.div_floor(scalar(p.resolution));

    let off = pos - cell * scalar(p.resolution);
    let u = smooth(off.x as f64 / p.resolution as f64);
    let v = smooth(off.y as f64 / p.resolution as f64);

    let corner = |x, y| {
        let step = V2::new(x, y);
        let d = pos - (cell + step) * scalar(p.resolution);
        let dx = d.x as f64 / p.resolution as f64;
        let dy = d.y as f64 / p.resolution as f64;

        let idx = hash_point(p.seed, cell + step);
        let (gx, gy) = GRADIENT_TABLE[idx as usize % GRADIENT_TABLE.len()];

        dx * gx + dy * gy
    };

    let left = corner(0, 0) * (1. - v) + corner(0, 1) * v;
    let right = corner(1, 0) * (1. - v) + corner(1, 1) * v;
    let total = left * (1. - u) + right * u;

    (total * p.magnitude as f64).round() as i32
}


// AUTO-GENERATED by src/gen/tables/gen_perlin_gradients.py at Mon Feb  8 07:02:53 2016
static GRADIENT_TABLE: [(f64, f64); 64] = [
    (1.000000000000, 0.000000000000),
    (0.995184726672, 0.098017140330),
    (0.980785280403, 0.195090322016),
    (0.956940335732, 0.290284677254),
    (0.923879532511, 0.382683432365),
    (0.881921264348, 0.471396736826),
    (0.831469612303, 0.555570233020),
    (0.773010453363, 0.634393284164),
    (0.707106781187, 0.707106781187),
    (0.634393284164, 0.773010453363),
    (0.555570233020, 0.831469612303),
    (0.471396736826, 0.881921264348),
    (0.382683432365, 0.923879532511),
    (0.290284677254, 0.956940335732),
    (0.195090322016, 0.980785280403),
    (0.098017140330, 0.995184726672),
    (0.000000000000, 1.000000000000),
    (-0.098017140330, 0.995184726672),
    (-0.195090322016, 0.980785280403),
    (-0.290284677254, 0.956940335732),
    (-0.382683432365, 0.923879532511),
    (-0.471396736826, 0.881921264348),
    (-0.555570233020, 0.831469612303),
    (-0.634393284164, 0.773010453363),
    (-0.707106781187, 0.707106781187),
    (-0.773010453363, 0.634393284164),
    (-0.831469612303, 0.555570233020),
    (-0.881921264348, 0.471396736826),
    (-0.923879532511, 0.382683432365),
    (-0.956940335732, 0.290284677254),
    (-0.980785280403, 0.195090322016),
    (-0.995184726672, 0.098017140330),
    (-1.000000000000, 0.000000000000),
    (-0.995184726672, -0.098017140330),
    (-0.980785280403, -0.195090322016),
    (-0.956940335732, -0.290284677254),
    (-0.923879532511, -0.382683432365),
    (-0.881921264348, -0.471396736826),
    (-0.831469612303, -0.555570233020),
    (-0.773010453363, -0.634393284164),
    (-0.707106781187, -0.707106781187),
    (-0.634393284164, -0.773010453363),
    (-0.555570233020, -0.831469612303),
    (-0.471396736826, -0.881921264348),
    (-0.382683432365, -0.923879532511),
    (-0.290284677254, -0.956940335732),
    (-0.195090322016, -0.980785280403),
    (-0.098017140330, -0.995184726672),
    (-0.000000000000, -1.000000000000),
    (0.098017140330, -0.995184726672),
    (0.195090322016, -0.980785280403),
    (0.290284677254, -0.956940335732),
    (0.382683432365, -0.923879532511),
    (0.471396736826, -0.881921264348),
    (0.555570233020, -0.831469612303),
    (0.634393284164, -0.773010453363),
    (0.707106781187, -0.707106781187),
    (0.773010453363, -0.634393284164),
    (0.831469612303, -0.555570233020),
    (0.881921264348, -0.471396736826),
    (0.923879532511, -0.382683432365),
    (0.956940335732, -0.290284677254),
    (0.980785280403, -0.195090322016),
    (0.995184726672, -0.098017140330),
];
